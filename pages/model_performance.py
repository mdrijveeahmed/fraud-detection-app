# -*- coding: utf-8 -*-
"""Model_Performance

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1Z4O0HPtN1HIC8497DWA0CVUgEKjXUBlx
"""

import streamlit as st
import pickle
import pandas as pd
import seaborn as sns
import matplotlib.pyplot as plt
from sklearn.metrics import confusion_matrix, roc_curve, precision_recall_curve, auc

st.set_page_config(page_title="Model Performance", page_icon="ЁЯУИ")
st.title("ЁЯУИ ржоржбрзЗрж▓ ржкрж╛рж░ржлрж░ржорзНржпрж╛ржирзНрж╕ ржПржмржВ ржмрзНржпрж╛ржЦрзНржпрж╛")
st.write("ржПржЗ ржкрзЗржЗржЬрзЗ ржЖржорж░рж╛ ржжрзЗржЦржмрзЛ ржЖржорж╛ржжрзЗрж░ XGBoost ржоржбрзЗрж▓ржЯрж┐ рдкрд░реНрджреЗ рдХреЗ рдкреАрдЫреЗ ржХрзАржнрж╛ржмрзЗ ржХрж╛ржЬ ржХрж░ржЫрзЗред")

# --- ржкрзНрж░рзЯрзЛржЬржирзАрзЯ ржлрж╛ржЗрж▓ рж▓рзЛржб ржХрж░рж╛ ---
@st.cache_data
def load_assets():
    try:
        with open('fraud_detection_model.pkl', 'rb') as f:
            model = pickle.load(f)
        with open('test_data.pkl', 'rb') as f:
            test_data = pickle.load(f)
        with open('feature_names.pkl', 'rb') as f:
            feature_names = pickle.load(f)

        X_test = test_data['X_test']
        y_test = test_data['y_test']
        return model, X_test, y_test, feature_names
    except FileNotFoundError:
        st.error("ржкрзНрж░рзЯрзЛржЬржирзАрзЯ ржлрж╛ржЗрж▓ (.pkl) ржкрж╛ржУрзЯрж╛ ржпрж╛рзЯржирж┐ред GitHub-ржП рж╕ржм ржлрж╛ржЗрж▓ ржЖржкрж▓рзЛржб рж╣рзЯрзЗржЫрзЗ ржХрж┐ржирж╛ ржжрзЗржЦрзБржиред")
        return None, None, None, None

model, X_test, y_test, feature_names = load_assets()

if model:
    # --- ржоржбрзЗрж▓рзЗрж░ ржкрзНрж░рзЗржбрж┐ржХрж╢ржи рждрзИрж░рж┐ ржХрж░рж╛ ---
    y_pred = model.predict(X_test)
    y_proba = model.predict_proba(X_test)[:, 1] # ржлрзНрж░ржб рж╣ржУрзЯрж╛рж░ рж╕ржорзНржнрж╛ржмржирж╛

    # --- рзз. ржлрж┐ржЪрж╛рж░ ржЗржорзНржкрж░рзНржЯрзНржпрж╛ржирзНрж╕ (Feature Importance) ---
    st.header("рзз. ржлрж┐ржЪрж╛рж░ ржЗржорзНржкрж░рзНржЯрзНржпрж╛ржирзНрж╕ (Model Explainability)")
    st.write("ржоржбрзЗрж▓ржЯрж┐ ржХрзЛржи ржмрж┐рж╖рзЯржЧрзБрж▓рзЛржХрзЗ рж╕ржмржЪрзЗрзЯрзЗ ржмрзЗрж╢рж┐ ржЧрзБрж░рзБрждрзНржм ржжрж┐рзЯрзЗ 'ржлрзНрж░ржб' рж╢ржирж╛ржХрзНржд ржХрж░ржЫрзЗ?")

    try:
        importance = model.feature_importances_
        feature_importance_df = pd.DataFrame({
            'Feature': feature_names,
            'Importance': importance
        }).sort_values(by='Importance', ascending=False)

        # рж╕рзЗрж░рж╛ рззрзжржЯрж┐ ржлрж┐ржЪрж╛рж░ ржжрзЗржЦрж╛ржирзЛ
        fig_imp, ax_imp = plt.subplots(figsize=(10, 6))
        sns.barplot(x='Importance', y='Feature', data=feature_importance_df.head(10), ax=ax_imp)
        ax_imp.set_title("ржЯржк рззрзжржЯрж┐ ржЧрзБрж░рзБрждрзНржмржкрзВрж░рзНржг ржлрж┐ржЪрж╛рж░", fontsize=16)
        st.pyplot(fig_imp)

    except Exception as e:
        st.warning(f"ржлрж┐ржЪрж╛рж░ ржЗржорзНржкрж░рзНржЯрзНржпрж╛ржирзНрж╕ ржЪрж╛рж░рзНржЯ рж▓рзЛржб ржХрж░рж╛ ржпрж╛рзЯржирж┐: {e}")


    # --- рзи. ржХржиржлрж┐ржЙрж╢ржи ржорзНржпрж╛ржЯрзНрж░рж┐ржХрзНрж╕ (Confusion Matrix) ---
    st.header("рзи. ржХржиржлрж┐ржЙрж╢ржи ржорзНржпрж╛ржЯрзНрж░рж┐ржХрзНрж╕")
    st.write("ржоржбрзЗрж▓ржЯрж┐ ржХрждржЧрзБрж▓рзЛ ржкрзНрж░рзЗржбрж┐ржХрж╢ржи рж╕ржарж┐ржХ ржПржмржВ ржХрждржЧрзБрж▓рзЛ ржнрзБрж▓ ржХрж░рзЗржЫрзЗ рждрж╛рж░ ржмрж┐рж╕рзНрждрж╛рж░рж┐рждред")

    cm = confusion_matrix(y_test, y_pred)
    fig_cm, ax_cm = plt.subplots(figsize=(7, 5))
    sns.heatmap(cm, annot=True, fmt='d', cmap='Blues',
                xticklabels=['Normal', 'Fraud'],
                yticklabels=['Normal', 'Fraud'], ax=ax_cm)
    ax_cm.set_xlabel("ржкрзНрж░рзЗржбрж┐ржХрзНржЯрзЗржб ржХрзНрж▓рж╛рж╕")
    ax_cm.set_ylabel("ржЖрж╕рж▓ ржХрзНрж▓рж╛рж╕")
    ax_cm.set_title("Confusion Matrix", fontsize=16)
    st.pyplot(fig_cm)

    st.info(f"""
    * **True Positive (TP):** {cm[1][1]} ржЯрж┐ ржлрзНрж░ржб ржХрзЗрж╕ рж╕ржарж┐ржХржнрж╛ржмрзЗ ржзрж░рзЗржЫрзЗред
    * **False Negative (FN):** {cm[1][0]} ржЯрж┐ ржлрзНрж░ржб ржХрзЗрж╕ ржзрж░рждрзЗ **ржмрзНржпрж░рзНрже** рж╣рзЯрзЗржЫрзЗред (ржПржЯрж┐ржЗ рж╕ржмржЪрзЗрзЯрзЗ ржХрзНрж╖рждрж┐ржХрж░!)
    * **False Positive (FP):** {cm[0][1]} ржЯрж┐ рж╕рзНржмрж╛ржнрж╛ржмрж┐ржХ ржХрзЗрж╕ржХрзЗ ржнрзБрж▓ржмрж╢ржд 'ржлрзНрж░ржб' ржмрж▓рзЗржЫрзЗред
    """)

    # --- рзй. ROC ржПржмржВ Precision-Recall ржХрж╛рж░рзНржн ---
    st.header("рзй. ржЕрзНржпрж╛ржбржнрж╛ржирзНрж╕ржб ржкрж╛рж░ржлрж░ржорзНржпрж╛ржирзНрж╕ ржХрж╛рж░рзНржн")

    col1, col2 = st.columns(2)

    with col1:
        st.subheader("ROC Curve")
        fpr, tpr, _ = roc_curve(y_test, y_proba)
        roc_auc = auc(fpr, tpr)

        fig_roc, ax_roc = plt.subplots()
        ax_roc.plot(fpr, tpr, label=f'AUC = {roc_auc:.2f}')
        ax_roc.plot([0, 1], [0, 1], 'k--') # Random guess line
        ax_roc.set_xlabel('False Positive Rate')
        ax_roc.set_ylabel('True Positive Rate')
        ax_roc.set_title('Receiver Operating Characteristic')
        ax_roc.legend(loc='lower right')
        st.pyplot(fig_roc)

    with col2:
        st.subheader("Precision-Recall Curve")
        precision, recall, _ = precision_recall_curve(y_test, y_proba)
        pr_auc = auc(recall, precision)

        fig_pr, ax_pr = plt.subplots()
        ax_pr.plot(recall, precision, label=f'AUC = {pr_auc:.2f}')
        ax_pr.set_xlabel('Recall')
        ax_pr.set_ylabel('Precision')
        ax_pr.set_title('Precision-Recall Curve')
        ax_pr.legend(loc='lower left')
        st.pyplot(fig_pr)

    st.markdown("""
    **ржХрзАржнрж╛ржмрзЗ ржПржЗ ржЪрж╛рж░рзНржЯржЧрзБрж▓рзЛ ржкрзЬржмрзЗржи:**
    * **ROC Curve:** ржЪрж╛рж░рзНржЯржЯрж┐ ржпржд ржЙржкрж░рзЗрж░-ржмрж╛ржо ржХрзЛржгрж╛рж░ ржХрж╛ржЫрж╛ржХрж╛ржЫрж┐ ржпрж╛ржмрзЗ, ржоржбрзЗрж▓ рждржд ржнрж╛рж▓рзЛред
    * **Precision-Recall Curve:** ржПржЗ ржзрж░ржирзЗрж░ ржЗржоржмрзНржпрж╛рж▓рж╛ржирзНрж╕ржб ржбрзЗржЯрж╛рж╕рзЗржЯрзЗрж░ ржЬржирзНржп ржПржЯрж┐ ржмрзЗрж╢рж┐ ржЧрзБрж░рзБрждрзНржмржкрзВрж░рзНржгред ржЪрж╛рж░рзНржЯржЯрж┐ ржпржд ржЙржкрж░рзЗрж░-ржбрж╛ржи ржХрзЛржгрж╛рж░ ржХрж╛ржЫрж╛ржХрж╛ржЫрж┐ ржпрж╛ржмрзЗ, ржоржбрзЗрж▓ рждржд ржнрж╛рж▓рзЛред
    """)

else:
    st.error("ржЕрзНржпрж╛ржкржЯрж┐ рж▓рзЛржб ржХрж░рж╛рж░ ржЬржирзНржп ржкрзНрж░рзЯрзЛржЬржирзАрзЯ ржлрж╛ржЗрж▓ ржкрж╛ржУрзЯрж╛ ржпрж╛рзЯржирж┐ред")